{% extends 'base.html' %}
{% load static custom_filters %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
    {% with first_storage=product.storage_options.first %}
    
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-sm text-gray-500 mb-6">
        <a href="{% url 'home' %}" class="hover:text-primary transition">Trang chu</a>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
        <span class="text-gray-800">{{ product.brand }} {{ product.name }}</span>
    </nav>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Cot trai: Hinh anh -->
        <div class="space-y-4">
            <!-- Anh chinh -->
            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                <img id="mainImage" 
                     src="{{ product.main_image.url }}" 
                     alt="{{ product.brand }} {{ product.name }}"
                     class="w-full h-[400px] object-contain p-4">
            </div>
            
            <!-- Gallery anh nho -->
            {% if product.images.exists %}
            <div class="flex gap-3 overflow-x-auto">
                <button onclick="changeImage('{{ product.main_image.url }}')" 
                        class="gallery-btn flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden border-2 border-primary transition">
                    <img src="{{ product.main_image.url }}" alt="Anh chinh" class="w-full h-full object-cover">
                </button>
                
                {% for img in product.images.all %}
                <button onclick="changeImage('{{ img.image.url }}')" 
                        class="gallery-btn flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden border-2 border-gray-300 hover:border-primary transition">
                    <img src="{{ img.image.url }}" alt="Anh {{ forloop.counter }}" class="w-full h-full object-cover">
                </button>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- Cot phai: Thong tin san pham -->
        <div class="space-y-4">
            <!-- Ten va thuong hieu -->
            <div>
                <p class="text-gray-500 text-sm">{{ product.brand }}</p>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">{{ product.name }}</h1>
            </div>
            
            <!-- Gia - Hien thi gia cua storage duoc chon -->
            <div class="bg-white rounded-xl border border-gray-200 p-4">
                <div class="flex items-baseline gap-3">
                    <span class="text-gray-400 line-through text-lg" id="originalPrice">
                        {% if first_storage %}{{ first_storage.original_price|format_vnd }}{% else %}{{ product.original_price|format_vnd }}{% endif %}
                    </span>
                    <span class="text-red-600 text-3xl font-bold" id="salePrice">
                        {% if first_storage %}{{ first_storage.sale_price|format_vnd }}{% else %}{{ product.sale_price|format_vnd }}{% endif %}
                    </span>
                    <span class="bg-red-500 text-white px-2 py-1 rounded text-sm font-bold" id="discountBadge">
                        -{{ product.discount_percent|floatformat:0 }}%
                    </span>
                </div>
                <p class="text-sm text-gray-500 mt-1">Gia da bao gom khuyen mai {{ product.discount_percent|floatformat:0 }}%</p>
            </div>
            
            <!-- Chon bo nho -->
            {% if product.storage_options.exists %}
            <div>
                <h3 class="font-semibold text-gray-700 mb-3">Chon bo nho:</h3>
                <div class="flex flex-wrap gap-2" id="storageOptions">
                    {% for storage in product.storage_options.all %}
                    <button onclick="selectStorage(this, '{{ storage.storage }}', {{ storage.original_price }}, {{ storage.sale_price }})"
                            class="storage-btn border-2 border-gray-200 rounded-lg px-4 py-2 hover:border-primary hover:bg-blue-50 transition
                                   {% if forloop.first %}border-primary bg-blue-50{% endif %}"
                            data-storage="{{ storage.storage }}"
                            data-original-price="{{ storage.original_price }}"
                            data-sale-price="{{ storage.sale_price }}">
                        <span class="font-medium">{{ storage.storage }}</span>
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Chon mau sac -->
            {% if product.color_options.exists %}
            <div>
                <h3 class="font-semibold text-gray-700 mb-3">Chon mau sac:</h3>
                <div class="flex flex-wrap gap-2" id="colorOptions">
                    {% for color in product.color_options.all %}
                    <button type="button" 
                            class="color-btn border-2 border-gray-200 rounded-lg px-4 py-2 hover:border-primary hover:bg-blue-50 transition
                                   {% if forloop.first %}border-primary bg-blue-50{% endif %}"
                            data-color="{{ color.color_name }}"
                            data-image="{% if color.color_image %}{{ color.color_image.url }}{% else %}{{ product.main_image.url }}{% endif %}"
                            onclick="selectColor(this)">
                        <span class="font-medium">{{ color.color_name }}</span>
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Nut mua hang -->
            <div class="flex gap-3">
                <!-- Them vao gio hang -->
                <form action="{% url 'cart_add' product.id %}" method="POST" class="flex-1">
                    {% csrf_token %}
                    <input type="hidden" name="storage" id="selectedStorage" value="{{ product.storage_options.first.storage|default:'' }}">
                    <input type="hidden" name="color" id="selectedColor" value="{{ product.color_options.first.color_name|default:'' }}">
                    <input type="hidden" name="quantity" value="1">
                    <button type="submit" class="w-full bg-red-500 text-white py-3 rounded-xl font-semibold hover:bg-red-600 hover:shadow-lg transition-all duration-300 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        Them vao gio hang
                    </button>
                </form>
                
                <!-- Mua ngay -->
                <form action="{% url 'buy_now' product.id %}" method="POST" class="flex-1">
                    {% csrf_token %}
                    <input type="hidden" name="storage" id="buyNowStorage" value="{{ product.storage_options.first.storage|default:'' }}">
                    <input type="hidden" name="color" id="buyNowColor" value="{{ product.color_options.first.color_name|default:'' }}">
                    <input type="hidden" name="quantity" value="1">
                    <button type="submit" class="w-full bg-primary text-white py-3 rounded-xl font-semibold hover:bg-blue-600 hover:shadow-lg transition-all duration-300 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        Mua ngay
                    </button>
                </form>
            </div>

                        <!-- 4 Badges in 1 row -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <span class="inline-flex items-center justify-center gap-1.5 bg-green-50 text-green-700 px-3 py-2.5 rounded-lg text-xs font-medium border border-green-200">
                                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
                                </svg>
                                <span class="text-center">Mien phi giao hang</span>
                            </span>
                            <span class="inline-flex items-center justify-center gap-1.5 bg-blue-50 text-blue-700 px-3 py-2.5 rounded-lg text-xs font-medium border border-blue-200">
                                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
                                </svg>
                                <span class="text-center">Mo hop kiem tra</span>
                            </span>
                            <span class="inline-flex items-center justify-center gap-1.5 bg-purple-50 text-purple-700 px-3 py-2.5 rounded-lg text-xs font-medium border border-purple-200">
                                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                                <span class="text-center">Doi tra 30 ngay</span>
                            </span>
                            <span class="inline-flex items-center justify-center gap-1.5 bg-orange-50 text-orange-700 px-3 py-2.5 rounded-lg text-xs font-medium border border-orange-200">
                                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span class="text-center">Bao xai loi 1 doi 1</span>
                            </span>
                        </div>
        </div>
    </div>
    
    <!-- Mo ta san pham -->
    <div class="mt-10">
        <div class="flex items-center gap-4 mb-4">
            <div class="flex-1 h-px bg-gray-200"></div>
            <h2 class="text-xl font-bold text-gray-800">Mo ta & Thong so ky thuat</h2>
            <div class="flex-1 h-px bg-gray-200"></div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Mo ta san pham -->
            <div class="bg-white rounded-xl border border-gray-200 p-5">
                <h3 class="font-semibold text-gray-800 mb-3 pb-2 border-b border-gray-100">Mo ta san pham</h3>
                {% if product.description %}
                <div class="prose prose-gray max-w-none">
                    <p class="whitespace-pre-line text-gray-600 text-sm">{{ product.description }}</p>
                </div>
                {% else %}
                <p class="text-gray-400 italic text-center py-6 text-sm">Chua co mo ta cho san pham nay.</p>
                {% endif %}
            </div>
            
            <!-- Thong so ky thuat -->
            <div class="bg-white rounded-xl border border-gray-200 p-5">
                <h3 class="font-semibold text-gray-800 mb-3 pb-2 border-b border-gray-100">Thong so ky thuat</h3>
                {% if product.specifications %}
                <pre class="whitespace-pre-line text-gray-600 font-sans text-sm">{{ product.specifications }}</pre>
                {% else %}
                <p class="text-gray-400 italic text-center py-6 text-sm">Chua co thong so ky thuat cho san pham nay.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Danh gia san pham -->
    <div class="mt-8">
        <div class="flex items-center gap-4 mb-4">
            <div class="flex-1 h-px bg-gray-200"></div>
            <h2 class="text-xl font-bold text-gray-800">Danh gia san pham ({{ reviews.count }})</h2>
            <div class="flex-1 h-px bg-gray-200"></div>
        </div>
        
        {% if reviews %}
        <div class="space-y-4 mb-6">
            {% for review in reviews %}
            <div class="bg-white rounded-xl border border-gray-200 p-5">
                <div class="flex items-start gap-4">
                    <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-sm font-medium text-gray-600">
                            {{ review.get_display_name|upper|make_list|first }}
                        </span>
                    </div>
                    <div class="flex-grow">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-gray-800">{{ review.get_display_name }}</span>
                            <span class="text-gray-400 text-sm">{{ review.created_at|date:"d/m/Y H:i" }}</span>
                        </div>
                        <p class="text-gray-600">{{ review.comment }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-white rounded-xl border border-gray-200 p-8 text-center">
            <svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            <p class="text-gray-500">Chua co danh gia nao cho san pham nay.</p>
        </div>
        {% endif %}
        
        {% if review_form %}
        <div class="bg-white rounded-xl border border-gray-200 p-6 mt-6">
            <h3 class="font-semibold text-gray-800 mb-4">Them danh gia cua ban</h3>
            <form method="POST" action="{% url 'add_review' product.id %}">
                {% csrf_token %}
                <div class="mb-4">
                    <textarea name="comment" rows="4" required
                              placeholder="Chia se truong hop cua ban..."
                              class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition"></textarea>
                </div>
                <div class="mb-4 flex items-center gap-2">
                    <input type="checkbox" name="is_anonymous" id="id_is_anonymous" value="false"
                           class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
                    <label for="id_is_anonymous" class="text-gray-600 text-sm cursor-pointer">
                        Đánh giá ẩn danh (tên sẽ hiển thị dạng T*******)
                    </label>
                </div>
                <button type="submit" 
                        class="bg-primary text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-blue-600 hover:shadow-lg transition-all duration-300">
                    Gui danh gia
                </button>
            </form>
        </div>
        {% elif not request.user.is_authenticated %}
        <div class="bg-white rounded-xl border border-gray-200 p-6 text-center">
            <p class="text-gray-500">
                <a href="{% url 'login' %}" class="text-primary font-medium hover:underline">Dang nhap</a> de danh gia san pham
            </p>
        </div>
        {% elif not has_purchased %}
        <div class="bg-white rounded-xl border border-orange-200 p-6 text-center bg-orange-50">
            <svg class="w-12 h-12 text-orange-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <p class="text-orange-700 font-medium mb-2">Ban can mua san pham nay de co the danh gia</p>
            <p class="text-orange-600 text-sm">Mua san pham hoan thanh se mo khoa chuc nang danh gia</p>
        </div>
        {% endif %}
    </div>
    
    {% endwith %}
</div>

<!-- JavaScript cho gia dynamic -->
<script>
    let currentStorage = '';
    
    function changeImage(imageUrl) {
        const mainImage = document.getElementById('mainImage');
        if (mainImage && imageUrl) {
            mainImage.src = imageUrl;
        }
    }
    
    function selectStorage(button, storage, originalPrice, salePrice) {
        // Cap nhat UI
        const buttons = document.querySelectorAll('.storage-btn');
        buttons.forEach(btn => {
            btn.classList.remove('border-primary', 'bg-blue-50');
            btn.classList.add('border-gray-200');
        });
        button.classList.remove('border-gray-200');
        button.classList.add('border-primary', 'bg-blue-50');
        
        // Cap nhat gia
        currentStorage = storage;
        
        document.getElementById('originalPrice').textContent = parseInt(originalPrice).toLocaleString('vi-VN') + 'đ';
        document.getElementById('salePrice').textContent = parseInt(salePrice).toLocaleString('vi-VN') + 'đ';
        
        // Cap nhat hidden inputs cho Add to Cart
        const selectedStorageInput = document.getElementById('selectedStorage');
        if (selectedStorageInput) selectedStorageInput.value = storage;
        
        // Cap nhat hidden inputs cho Buy Now
        const buyNowStorageInput = document.getElementById('buyNowStorage');
        if (buyNowStorageInput) buyNowStorageInput.value = storage;
    }
    
    function selectColor(button) {
        // Lay image tu data attribute
        const imageUrl = button.getAttribute('data-image');
        const colorName = button.getAttribute('data-color');
        
        // Cap nhat UI
        const buttons = document.querySelectorAll('.color-btn');
        buttons.forEach(btn => {
            btn.classList.remove('border-primary', 'bg-blue-50');
            btn.classList.add('border-gray-200');
        });
        button.classList.remove('border-gray-200');
        button.classList.add('border-primary', 'bg-blue-50');
        
        // Doi anh chinh
        if (imageUrl) {
            changeImage(imageUrl);
        }
        
        // Cap nhat hidden inputs cho Add to Cart
        const selectedColorInput = document.getElementById('selectedColor');
        if (selectedColorInput) selectedColorInput.value = colorName;
        
        // Cap nhat hidden inputs cho Buy Now
        const buyNowColorInput = document.getElementById('buyNowColor');
        if (buyNowColorInput) buyNowColorInput.value = colorName;
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function initGallery() {
        const thumbnails = document.querySelectorAll('.gallery-btn');
        thumbnails.forEach(function(thumb) {
            thumb.addEventListener('click', function(e) {
                e.preventDefault();
                
                const onclickAttr = this.getAttribute('onclick');
                const match = onclickAttr.match(/changeImage\(['"]([^'"]+)['"]\)/);
                if (match && match[1]) {
                    changeImage(match[1]);
                }
                
                thumbnails.forEach(function(t) {
                    t.classList.remove('border-primary');
                    t.classList.add('border-gray-200');
                });
                this.classList.remove('border-gray-200');
                this.classList.add('border-primary');
            });
        });
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        initGallery();
    });
</script>
{% endblock %}
