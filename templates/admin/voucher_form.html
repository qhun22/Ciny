{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin.css' %}">
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-max-width">
        <div class="flex flex-col md:flex-row gap-6">
            <!-- Left Sidebar -->
            <div class="admin-sidebar">
                <div class="admin-sidebar-card">
                    <h2 class="admin-sidebar-title">Qu·∫£n tr·ªã</h2>
                    
                    <!-- B·∫£ng ƒëi·ªÅu khi·ªÉn -->
                    <a href="{% url 'admin_dashboard' %}" 
                       class="admin-sidebar-btn">
                        B·∫£ng ƒëi·ªÅu khi·ªÉn
                    </a>
                    
                    <!-- Qu·∫£n l√Ω s·∫£n ph·∫©m -->
                    <a href="{% url 'admin_product_list' %}" 
                       class="admin-sidebar-btn">
                        üì¶ Qu·∫£n l√Ω s·∫£n ph·∫©m
                    </a>
                    
                    <!-- Qu·∫£n l√Ω ƒë∆°n h√†ng -->
                    <a href="{% url 'admin_orders' %}" 
                       class="admin-sidebar-btn">
                        üõí Qu·∫£n l√Ω ƒë∆°n h√†ng
                    </a>
                    
                    <!-- Qu·∫£n l√Ω m√£ gi·∫£m gi√° -->
                    <a href="{% url 'admin_vouchers' %}" 
                       class="admin-sidebar-btn active">
                        üé´ Qu·∫£n l√Ω voucher
                    </a>
                    
                    <!-- Qu·∫£n l√Ω g√≥p √Ω -->
                    <a href="{% url 'admin_feedbacks' %}" 
                       class="admin-sidebar-btn">
                        üí¨ Qu·∫£n l√Ω g√≥p √Ω
                    </a>
                    
                    <!-- Qu·∫£n l√Ω ƒë√°nh gi√° -->
                    <a href="{% url 'admin_reviews' %}" 
                       class="admin-sidebar-btn">
                        ‚≠ê Qu·∫£n l√Ω ƒë√°nh gi√°
                    </a>
                    
                    <!-- Qu·∫£n l√Ω ng∆∞·ªùi d√πng -->
                    <a href="{% url 'admin_users' %}" 
                       class="admin-sidebar-btn">
                        üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng
                    </a>
                    
                    <!-- Xem trang web -->
                    <a href="{% url 'home' %}" 
                       class="admin-sidebar-btn">
                        üåê Xem trang web
                    </a>
                </div>
            </div>

            <!-- Right Content -->
            <div class="admin-content">
                <!-- Header -->
                <div class="admin-header">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="admin-title">{% if voucher %}‚úèÔ∏è Ch·ªânh s·ª≠a voucher{% else %}‚ûï Th√™m voucher m·ªõi{% endif %}</h1>
                        </div>
                        <a href="{% url 'admin_vouchers' %}" class="btn-edit" style="background-color: #6b7280;">
                            ‚Üê Quay l·∫°i
                        </a>
                    </div>
                </div>

                <!-- Form -->
                <div class="admin-card">
                    <form method="POST" id="voucherForm">
                        {% csrf_token %}
                        
                        <!-- TH√îNG TIN C∆† B·∫¢N -->
                        <div class="bg-blue-50 rounded-lg p-4 mb-4">
                            <h3 class="text-blue-800 font-semibold mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Th√¥ng tin c∆° b·∫£n
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- M√£ voucher -->
                                <div>
                                    <label class="block text-gray-700 mb-2">M√£ voucher *</label>
                                    <input type="text" name="code" 
                                           value="{{ voucher.code|default:'' }}" required
                                           placeholder="V√≠ d·ª•: SUMMER2024"
                                           class="admin-input" style="text-transform: uppercase;">
                                </div>
                            </div>
                            
                            <!-- M√¥ t·∫£ voucher -->
                            <div class="mt-4">
                                <label class="block text-gray-700 mb-2">M√¥ t·∫£ voucher</label>
                                <textarea name="description" rows="3"
                                          placeholder="Nh·∫≠p m√¥ t·∫£ voucher (t√πy ch·ªçn)..."
                                          class="admin-input">{{ voucher.description|default:'' }}</textarea>
                            </div>
                        </div>
                        
                        <!-- GI√Å TR·ªä GI·∫¢M GI√Å -->
                        <div class="bg-green-50 rounded-lg p-4 mb-4">
                            <h3 class="text-green-800 font-semibold mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Gi√° tr·ªã gi·∫£m gi√°
                            </h3>
                            
                            <!-- Button Xem them -->
                            <button type="button" onclick="toggleDiscountOptions()" 
                                    class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer">
                                <span id="discount_type_label">
                                    {% if voucher.discount_type == 'percent' %}Ph·∫ßn trƒÉm (%){% else %}Ti·ªÅn c·ªë ƒë·ªãnh (ƒë){% endif %}
                                </span>
                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                            
                            <!-- Dropdown options (an mac dinh) -->
                            <div id="discount_options" class="hidden mt-2 p-3 bg-white rounded-lg border border-gray-200 shadow-lg max-h-48 overflow-y-auto">
                                <label class="flex items-center gap-3 p-2 rounded cursor-pointer hover:bg-gray-100 transition-colors">
                                    <input type="radio" name="discount_type" value="percent" 
                                           {% if voucher.discount_type != 'fixed' %}checked{% endif %}
                                           class="w-5 h-5 text-green-600"
                                           onchange="selectDiscountType('percent')">
                                    <span class="font-medium text-gray-700">Ph·∫ßn trƒÉm (%)</span>
                                </label>
                                <label class="flex items-center gap-3 p-2 rounded cursor-pointer hover:bg-gray-100 transition-colors">
                                    <input type="radio" name="discount_type" value="fixed" 
                                           {% if voucher.discount_type == 'fixed' %}checked{% endif %}
                                           class="w-5 h-5 text-green-600"
                                           onchange="selectDiscountType('fixed')">
                                    <span class="font-medium text-gray-700">Ti·ªÅn c·ªë ƒë·ªãnh (ƒë)</span>
                                </label>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <!-- Gia tri giam theo % -->
                                <div id="percent_input_container" class="{% if voucher.discount_type == 'fixed' %}opacity-50{% endif %}">
                                    <label class="block text-gray-700 mb-2">Nh·∫≠p ph·∫ßn trƒÉm (%)</label>
                                    <div class="relative">
                                        <input type="number" name="discount_value_percent" 
                                               value="{% if voucher.discount_type != 'fixed' %}{{ voucher.discount_value|default:0 }}{% endif %}"
                                               min="0" max="100"
                                               placeholder="0"
                                               class="admin-input pr-8 {% if voucher.discount_type == 'fixed' %}pointer-events-none{% endif %}"
                                               {% if voucher.discount_type == 'fixed' %}disabled{% endif %}
                                               oninput="updateDiscountValue('percent', this.value)">
                                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">%</span>
                                    </div>
                                </div>
                                
                                <!-- Gia tri giam theo tien -->
                                <div id="fixed_input_container" class="{% if voucher.discount_type != 'fixed' %}opacity-50{% endif %}">
                                    <label class="block text-gray-700 mb-2">Nh·∫≠p s·ªë ti·ªÅn (ƒë)</label>
                                    <input type="number" name="discount_value_fixed" 
                                           value="{% if voucher.discount_type == 'fixed' %}{{ voucher.discount_value|default:0 }}{% endif %}"
                                           min="0"
                                           placeholder="0"
                                           class="admin-input {% if voucher.discount_type != 'fixed' %}pointer-events-none{% endif %}"
                                           {% if voucher.discount_type != 'fixed' %}disabled{% endif %}
                                           oninput="updateDiscountValue('fixed', this.value)">
                                </div>
                            </div>
                            
                            <!-- Hidden input for actual discount_value -->
                            <input type="hidden" name="discount_value" id="discount_value" value="{{ voucher.discount_value|default:0 }}">
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <!-- ƒê∆°n h√†ng t·ªëi thi·ªÉu -->
                                <div>
                                    <label class="block text-gray-700 mb-2">ƒê∆°n h√†ng t·ªëi thi·ªÉu (ƒë)</label>
                                    <input type="number" name="min_order" 
                                           value="{{ voucher.min_order|default:0 }}"
                                           min="0"
                                           placeholder="Nh·∫≠p gi√° tr·ªã t·ªëi thi·ªÉu"
                                           class="admin-input">
                                </div>
                                
                                <!-- Gi·ªõi h·∫°n s·ª≠ d·ª•ng m·ªói user -->
                                <div>
                                    <label class="block text-gray-700 mb-2">M·ªói user s·ª≠ d·ª•ng t·ªëi ƒëa</label>
                                    <div class="relative">
                                        <input type="number" name="max_usage_per_user" 
                                               value="{{ voucher.max_usage_per_user|default:1 }}"
                                               min="0"
                                               placeholder="1"
                                               class="admin-input pr-8">
                                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">l·∫ßn</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">0 = kh√¥ng gi·ªõi h·∫°n s·ªë l·∫ßn</p>
                                </div>
                                
                                <!-- S·ªë s·∫£n ph·∫©m t·ªëi ƒëa -->
                                <div>
                                    <label class="block text-gray-700 mb-2">S·∫£n ph·∫©m t·ªëi ƒëa c√πng l√∫c</label>
                                    <div class="relative">
                                        <input type="number" name="max_product_limit" 
                                               value="{{ voucher.max_product_limit|default:0 }}"
                                               min="0"
                                               placeholder="0"
                                               class="admin-input pr-8">
                                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">s·∫£n ph·∫©m</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">0 = kh√¥ng gi·ªõi h·∫°n. V√≠ d·ª•: set 1 th√¨ ch·ªâ √°p d·ª•ng cho 1 s·∫£n ph·∫©m</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI C√ì TH·ªÇ S·ª¨ D·ª§NG -->
                        <div class="bg-yellow-50 rounded-lg p-4 mb-4">
                            <h3 class="text-yellow-800 font-semibold mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                </svg>
                                Ai c√≥ th·ªÉ s·ª≠ d·ª•ng voucher?
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Ch·∫ø ƒë·ªô s·ª≠ d·ª•ng -->
                                <div>
                                    <label class="block text-gray-700 mb-2">Ch·∫ø ƒë·ªô √°p d·ª•ng</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors">
                                            <input type="radio" name="usage_type" value="all" 
                                                   {% if voucher.usage_type != 'specific' %}checked{% endif %}
                                                   class="w-5 h-5 text-blue-600"
                                                   onchange="toggleEmailField()">
                                            <div>
                                                <span class="font-medium text-gray-700">M·ªçi ng∆∞·ªùi</span>
                                                <p class="text-xs text-gray-500">T·∫•t c·∫£ ng∆∞·ªùi d√πng trong h·ªá th·ªëng ƒë·ªÅu c√≥ th·ªÉ s·ª≠ d·ª•ng</p>
                                            </div>
                                        </label>
                                        <label class="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors">
                                            <input type="radio" name="usage_type" value="specific" 
                                                   {% if voucher.usage_type == 'specific' %}checked{% endif %}
                                                   class="w-5 h-5 text-blue-600"
                                                   onchange="toggleEmailField()">
                                            <div>
                                                <span class="font-medium text-gray-700">Nh·∫≠p email</span>
                                                <p class="text-xs text-gray-500">Ch·ªâ ng∆∞·ªùi d√πng c√≥ email n√†y m·ªõi ƒë∆∞·ª£c s·ª≠ d·ª•ng</p>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Email c·ª• th·ªÉ -->
                                <div id="email_container" class="{% if voucher.usage_type != 'specific' %}opacity-50{% endif %}">
                                    <label class="block text-gray-700 mb-2">Email ng∆∞·ªùi d√πng</label>
                                    <input type="email" name="specific_email" id="specific_email"
                                           value="{{ voucher.specific_email|default:'' }}"
                                           placeholder="V√≠ d·ª•: ngocKhanh@gmail.com"
                                           class="admin-input {% if voucher.usage_type != 'specific' %}pointer-events-none{% endif %}"
                                           {% if voucher.usage_type != 'specific' %}disabled{% endif %}>
                                    <p class="text-xs text-gray-500 mt-1">Nh·∫≠p email ch√≠nh x√°c c·ªßa ng∆∞·ªùi d√πng ƒë∆∞·ª£c √°p d·ª•ng voucher n√†y</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- TH·ªúI H·∫†N & TR·∫†NG TH√ÅI -->
                        <div class="bg-purple-50 rounded-lg p-4 mb-4">
                            <h3 class="text-purple-800 font-semibold mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Th·ªùi h·∫°n & Tr·∫°ng th√°i
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- V√¥ th·ªùi h·∫°n -->
                                <div>
                                    <label class="block text-gray-700 mb-2">Th·ªùi h·∫°n s·ª≠ d·ª•ng</label>
                                    <div class="flex items-center gap-3 mt-2 p-3 bg-white rounded-lg border border-gray-200">
                                        <input type="checkbox" name="is_indefinite" id="is_indefinite"
                                               {% if not voucher.expires_at %}checked{% endif %}
                                               class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                                               onchange="toggleExpiryDate()">
                                        <label for="is_indefinite" class="text-gray-700 cursor-pointer">
                                            <span class="font-medium">V√¥ th·ªùi h·∫°n</span>
                                            <p class="text-xs text-gray-500 mt-0.5">Voucher kh√¥ng c√≥ th·ªùi h·∫°n s·ª≠ d·ª•ng</p>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Ng√†y h·∫øt h·∫°n -->
                                <div id="expiry_date_container" class="{% if not voucher.expires_at %}opacity-50{% endif %}">
                                    <label class="block text-gray-700 mb-2">Ng√†y h·∫øt h·∫°n</label>
                                    <input type="datetime-local" name="expires_at" id="expires_at"
                                           value="{% if voucher.expires_at %}{{ voucher.expires_at|date:'Y-m-d H:i' }}{% endif %}"
                                           class="admin-input {% if not voucher.expires_at %}pointer-events-none{% endif %}"
                                           {% if not voucher.expires_at %}disabled{% endif %}>
                                </div>
                            </div>
                            
                            <!-- Tr·∫°ng th√°i ho·∫°t ƒë·ªông -->
                            <div class="mt-4">
                                <div class="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200">
                                    <input type="checkbox" name="is_active" id="is_active"
                                           {% if voucher.is_active or not voucher %}checked{% endif %}
                                           class="w-5 h-5 text-green-600 rounded border-gray-300 focus:ring-green-500">
                                    <label for="is_active" class="text-gray-700 cursor-pointer">
                                        <span class="font-medium">Ho·∫°t ƒë·ªông</span>
                                        <p class="text-xs text-gray-500 mt-0.5">Voucher c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng</p>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- N√∫t h√†nh ƒë·ªông -->
                        <div class="flex gap-4 mt-6">
                            <button type="submit" class="btn-edit" style="background-color: #16a34a;">
                                {% if voucher %}üíæ L∆∞u thay ƒë·ªïi{% else %}‚ûï T·∫°o voucher{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleDiscountOptions() {
    const options = document.getElementById('discount_options');
    options.classList.toggle('hidden');
}

function selectDiscountType(type) {
    const label = document.getElementById('discount_type_label');
    const percentInput = document.querySelector('input[name="discount_value_percent"]');
    const fixedInput = document.querySelector('input[name="discount_value_fixed"]');
    const percentContainer = document.getElementById('percent_input_container');
    const fixedContainer = document.getElementById('fixed_input_container');
    const hiddenInput = document.getElementById('discount_value');
    
    // Update label
    if (type === 'percent') {
        label.textContent = 'Ph·∫ßn trƒÉm (%)';
    } else {
        label.textContent = 'Ti·ªÅn c·ªë ƒë·ªãnh (ƒë)';
    }
    
    // Toggle visibility and states
    if (type === 'percent') {
        percentContainer.classList.remove('opacity-50');
        fixedContainer.classList.add('opacity-50');
        
        percentInput.disabled = false;
        percentInput.classList.remove('pointer-events-none');
        fixedInput.disabled = true;
        fixedInput.classList.add('pointer-events-none');
        
        // Move value from fixed to percent if needed
        if (fixedInput.value && !percentInput.value) {
            percentInput.value = fixedInput.value;
        }
    } else {
        percentContainer.classList.add('opacity-50');
        fixedContainer.classList.remove('opacity-50');
        
        percentInput.disabled = true;
        percentInput.classList.add('pointer-events-none');
        fixedInput.disabled = false;
        fixedInput.classList.remove('pointer-events-none');
        
        // Move value from percent to fixed if needed
        if (percentInput.value && !fixedInput.value) {
            fixedInput.value = percentInput.value;
        }
    }
    
    // Update hidden input
    updateDiscountValue(type, type === 'percent' ? percentInput.value : fixedInput.value);
    
    // Hide dropdown
    document.getElementById('discount_options').classList.add('hidden');
}

function updateDiscountValue(type, value) {
    const hiddenInput = document.getElementById('discount_value');
    hiddenInput.value = value || 0;
}

function toggleEmailField() {
    const usageType = document.querySelector('input[name="usage_type"]:checked').value;
    const emailInput = document.getElementById('specific_email');
    const emailContainer = document.getElementById('email_container');
    
    if (usageType === 'specific') {
        emailInput.disabled = false;
        emailInput.classList.remove('pointer-events-none');
        emailContainer.classList.remove('opacity-50');
    } else {
        emailInput.disabled = true;
        emailInput.value = '';
        emailInput.classList.add('pointer-events-none');
        emailContainer.classList.add('opacity-50');
    }
}

function toggleExpiryDate() {
    const checkbox = document.getElementById('is_indefinite');
    const dateInput = document.getElementById('expires_at');
    const container = document.getElementById('expiry_date_container');
    
    if (checkbox.checked) {
        dateInput.disabled = true;
        dateInput.value = '';
        dateInput.classList.add('pointer-events-none');
        container.classList.add('opacity-50');
    } else {
        dateInput.disabled = false;
        dateInput.classList.remove('pointer-events-none');
        container.classList.remove('opacity-50');
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const options = document.getElementById('discount_options');
    const button = event.target.closest('button[onclick="toggleDiscountOptions()"]');
    
    if (options && !options.contains(event.target) && !button) {
        options.classList.add('hidden');
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set initial hidden input value
    const currentType = '{{ voucher.discount_type }}' || 'percent';
    const currentValue = {{ voucher.discount_value|default:0 }};
    document.getElementById('discount_value').value = currentValue;
    
    toggleEmailField();
    toggleExpiryDate();
});
</script>
{% endblock %}
