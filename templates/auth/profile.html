{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}H·ªì s∆° - QHUN22 Mobile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-max-width">
        <div class="flex flex-col md:flex-row gap-6">
            <!-- Left Sidebar -->
            <div class="profile-sidebar">
                <div class="profile-sidebar-card">
                    <h2 class="profile-sidebar-title">T√†i kho·∫£n</h2>
                    
                    <!-- T·ªïng quan tab -->
                    <button onclick="showTab('overview')" id="btn-overview"
                            class="profile-tab-btn {% if active_tab != 'addresses' and active_tab != 'vouchers' %}active{% endif %}">
                        T·ªïng quan
                    </button>
                    
                    <!-- S·ªï ƒë·ªãa ch·ªâ tab -->
                    <button onclick="showTab('addresses')" id="btn-addresses"
                            class="profile-tab-btn {% if active_tab == 'addresses' %}active{% endif %}">
                        S·ªï ƒë·ªãa ch·ªâ
                    </button>
                    
                    <!-- Voucher tab -->
                    <button onclick="showTab('vouchers')" id="btn-vouchers"
                            class="profile-tab-btn {% if active_tab == 'vouchers' %}active{% endif %}">
                        Voucher
                    </button>
                    
                    <!-- ƒê∆°n h√†ng tab -->
                    <button onclick="showTab('orders')" id="btn-orders"
                            class="profile-tab-btn {% if active_tab == 'orders' %}active{% endif %}">
                        ƒê∆°n h√†ng
                    </button>
                    
                    <!-- G√≥p √Ω tab -->
                    <button onclick="showTab('feedback')" id="btn-feedback"
                            class="profile-tab-btn {% if active_tab == 'feedback' %}active{% endif %}">
                        G√≥p √Ω
                    </button>
                    
                    {% if is_admin %}
                    <a href="{% url 'admin_dashboard' %}" 
                       class="w-full text-left px-4 py-3 hover:bg-gray-50 rounded-lg font-medium text-gray-600 mb-2 block">
                        Qu·∫£n tr·ªã
                    </a>
                    {% endif %}
                    <a href="{% url 'logout' %}" 
                       class="w-full text-left px-4 py-3 hover:bg-gray-50 rounded-lg font-medium text-gray-600 block">
                        ƒêƒÉng xu·∫•t
                    </a>
                </div>
            </div>

            <!-- Right Content -->
            <div class="profile-content">
                
                <!-- Tab: T·ªïng quan (Personal Info) -->
                <div id="tab-overview" class="{% if active_tab == 'addresses' or active_tab == 'vouchers' %}hidden{% endif %}">
                    <div class="profile-content-card">
                        <h3 class="section-title">Th√¥ng tin c√° nh√¢n</h3>
                        
                        <form method="POST" action="{% url 'profile' %}">
                            {% csrf_token %}
                            
                            <div class="grid grid-cols-1 gap-4 mb-4">
                                <!-- H·ªç v√† T√™n -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        H·ªç v√† t√™n
                                        <span class="verified-badge">ƒê√£ x√°c th·ª±c</span>
                                    </label>
                                    <div class="relative">
                                        <input type="text" 
                                               name="full_name"
                                               value="{{ user.first_name }}"
                                               disabled
                                               class="profile-input cursor-not-allowed">
                                        <svg class="w-5 h-5 text-green-500 absolute right-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">H·ªç v√† t√™n ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c v√† kh√≥a.</p>
                                </div>
                                
                                <!-- S·ªë ƒëi·ªán tho·∫°i -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        S·ªë ƒëi·ªán tho·∫°i
                                        {% if is_phone_verified %}
                                        <span class="verified-badge">ƒê√£ x√°c th·ª±c</span>
                                        {% endif %}
                                    </label>
                                    {% if is_phone_verified %}
                                    <input type="hidden" name="phone_number" value="{{ phone_number }}">
                                    <div class="relative">
                                        <input type="text" 
                                               value="{{ phone_number }}"
                                               disabled
                                               class="profile-input cursor-not-allowed">
                                        <svg class="w-5 h-5 text-green-500 absolute right-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">S·ªë ƒëi·ªán tho·∫°i ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c v√† kh√≥a.</p>
                                    {% else %}
                                    <input type="text" 
                                           name="phone_number"
                                           value="{% if phone_number %}{{ phone_number }}{% endif %}"
                                           placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
                                           class="profile-input">
                                    {% endif %}
                                </div>
                                
                                <!-- Email -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Email
                                        <span class="verified-badge">ƒê√£ x√°c th·ª±c</span>
                                    </label>
                                    <div class="relative">
                                        <input type="email" 
                                               value="{{ user.email }}"
                                               disabled
                                               class="profile-input cursor-not-allowed">
                                        <svg class="w-5 h-5 text-green-500 absolute right-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Email ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c v√† kh√≥a.</p>
                                </div>
                            </div>
                            
                            <!-- Divider -->
                            <hr class="profile-divider">
                            
                            <!-- Password Change -->
                            <h3 class="section-title">ƒê·ªïi m·∫≠t kh·∫©u</h3>
                            
                            <div class="grid grid-cols-1 gap-4 mb-4">
                                <div>
                                    <label class="profile-label">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                                    <input type="password" 
                                           name="old_password"
                                           placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i"
                                           class="profile-input">
                                </div>
                                
                                <div>
                                    <label class="profile-label">M·∫≠t kh·∫©u m·ªõi</label>
                                    <input type="password" 
                                           name="new_password1"
                                           placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi"
                                           class="profile-input">
                                </div>
                                
                                <div>
                                    <label class="profile-label">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi</label>
                                    <input type="password" 
                                           name="new_password2"
                                           placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi"
                                           class="profile-input">
                                </div>
                            </div>
                            
                            <div class="mt-6">
                                <button type="submit" class="btn-primary">
                                    L∆∞u
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Tab: S·ªï ƒë·ªãa ch·ªâ (Addresses) -->
                <div id="tab-addresses" class="{% if active_tab != 'addresses' %}hidden{% endif %}">
                    
                    <!-- Box 1: Th√™m ƒë·ªãa ch·ªâ m·ªõi -->
                    <div class="profile-content-card mb-6">
                        <h3 class="section-title">ƒê·ªãa ch·ªâ c·ªßa b·∫°n</h3>
                        
                        <form method="POST" action="{% url 'address_add' %}">
                            {% csrf_token %}
                            <div class="space-y-4">
                                <div>
                                    <label class="profile-label">Nh·∫≠p h·ªç t√™n</label>
                                    <input type="text" name="full_name" required
                                           placeholder="Nguy·ªÖn VƒÉn A"
                                           class="profile-input">
                                </div>
                                <div>
                                    <label class="profile-label">S·ªë ƒëi·ªán tho·∫°i</label>
                                    <input type="text" name="phone" required
                                           placeholder="0123 456 789"
                                           class="profile-input">
                                </div>
                                <div>
                                    <label class="profile-label">ƒê·ªãa ch·ªâ chi ti·∫øt</label>
                                    <input type="text" name="address" required
                                           placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£"
                                           class="profile-input">
                                </div>
                            </div>
                            <div class="mt-4">
                                <button type="submit" class="btn-primary">
                                    L∆∞u
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Box 2: S·ªï ƒë·ªãa ch·ªâ ƒë√£ l∆∞u -->
                    <div class="profile-content-card">
                        <h3 class="section-title">S·ªï ƒë·ªãa ch·ªâ c·ªßa b·∫°n</h3>
                        
                        {% if addresses %}
                        <form method="POST" action="{% url 'address_set_default' %}" id="addressForm">
                            {% csrf_token %}
                            
                            <div class="space-y-3">
                                {% for addr in addresses %}
                                <div class="address-card {% if addr.is_default %}active{% endif %}"
                                     onclick="selectAddress({{ addr.id }})">
                                    <div class="flex items-center gap-3">
                                        <input type="radio" name="default_address" value="{{ addr.id }}" 
                                               {% if addr.is_default %}checked{% endif %}
                                               id="addr_{{ addr.id }}"
                                               class="profile-radio">
                                        <div class="flex-1">
                                            <p class="font-medium text-gray-800">{{ addr.full_name }}</p>
                                            <p class="text-gray-600 text-sm">üìû {{ addr.phone }}</p>
                                            <p class="text-gray-600 text-sm">üìç {{ addr.address }}</p>
                                        </div>
                                        {% if addr.is_default %}
                                        <span class="default-badge">M·∫∑c ƒë·ªãnh</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Buttons -->
                            <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-200">
                                
                                <div class="flex gap-2">
                                    <button type="button" onclick="deleteSelectedAddress()" class="btn-danger">
                                        X√≥a
                                    </button>
                                    <button type="submit" form="addressForm" class="btn-primary">
                                        L∆∞u
                                    </button>
                                </div>
                            </div>
                        </form>
                        
                        <!-- Hidden delete form -->
                        <form method="POST" action="" id="deleteForm" style="display: none;">
                            {% csrf_token %}
                            <input type="hidden" name="address_id" id="deleteAddressId">
                        </form>
                        
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">üìç</div>
                            <p>B·∫°n ch∆∞a c√≥ ƒë·ªãa ch·ªâ n√†o.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Tab: Voucher -->
                <div id="tab-vouchers" class="{% if active_tab != 'vouchers' %}hidden{% endif %}">
                    <div class="profile-content-card">
                        <h3 class="section-title">Voucher c·ªßa b·∫°n</h3>
                        
                        {% if user_vouchers %}
                        <form method="POST" action="{% url 'voucher_delete' %}" id="deleteVouchersForm">
                            {% csrf_token %}
                            
                            <!-- Header -->
                            <div class="grid grid-cols-12 gap-4 py-3 px-4 bg-gray-100 rounded-t-lg font-medium text-gray-700">
                                <div class="col-span-1 text-center">
                                    <input type="checkbox" id="selectAllVouchers" 
                                           class="w-4 h-4 rounded border-gray-300"
                                           onchange="toggleAllVouchers(this)">
                                </div>
                                <div class="col-span-2">M√£</div>
                                <div class="col-span-3">M√¥ t·∫£</div>
                                <div class="col-span-2">Gi·∫£m gi√°</div>
                                <div class="col-span-2">ƒê∆°n t·ªëi thi·ªÉu</div>
                                <div class="col-span-2">Gi·ªõi h·∫°n</div>
                            </div>
                            
                            <!-- Voucher list -->
                            <div class="divide-y divide-gray-100">
                                {% for user_voucher in user_vouchers %}
                                <div class="grid grid-cols-12 gap-4 py-4 px-4 items-center hover:bg-gray-50 transition-colors">
                                    <div class="col-span-1 text-center">
                                        <input type="checkbox" name="voucher_ids[]" value="{{ user_voucher.id }}" 
                                               class="voucher-checkbox w-4 h-4 rounded border-gray-300">
                                    </div>
                                    <div class="col-span-2">
                                        <span class="font-bold text-blue-600 text-lg">{{ user_voucher.coupon.code }}</span>
                                    </div>
                                    <div class="col-span-3 text-gray-600 text-sm">
                                        {% if user_voucher.coupon.description %}
                                        {{ user_voucher.coupon.description|truncatechars:50 }}
                                        {% else %}
                                        <span class="text-gray-400 italic">Kh√¥ng c√≥ m√¥ t·∫£</span>
                                        {% endif %}
                                    </div>
                                    <div class="col-span-2">
                                        {% if user_voucher.coupon.discount_type == 'percent' %}
                                        <span class="inline-flex items-center px-2 py-1 bg-red-100 text-red-700 rounded text-sm font-medium">
                                            -{{ user_voucher.coupon.discount_value }}%
                                        </span>
                                        {% else %}
                                        <span class="inline-flex items-center px-2 py-1 bg-red-100 text-red-700 rounded text-sm font-medium">
                                            -{{ user_voucher.coupon.discount_value|floatformat:"0"|intcomma }}ƒë
                                        </span>
                                        {% endif %}
                                    </div>
                                    <div class="col-span-2 text-gray-600 text-sm">
                                        {{ user_voucher.coupon.min_order|floatformat:"0"|intcomma }}ƒë
                                    </div>
                                    <div class="col-span-2">
                                        {% if user_voucher.coupon.max_usage_per_user > 0 %}
                                        <span class="text-gray-600 text-sm">{{ user_voucher.coupon.max_usage_per_user }} l·∫ßn/user</span>
                                        {% else %}
                                        <span class="text-gray-400 text-sm">Kh√¥ng gi·ªõi h·∫°n</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Footer with delete button -->
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <button type="submit" 
                                        class="btn-danger">
                                    X√≥a voucher ƒë√£ ch·ªçn
                                </button>
                            </div>
                        </form>
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">üéÅ</div>
                            <p>B·∫°n ch∆∞a c√≥ voucher n√†o.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Tab: ƒê∆°n h√†ng (Orders) -->
                <div id="tab-orders" class="{% if active_tab != 'orders' %}hidden{% endif %}">
                    <div class="profile-content-card">
                        <h3 class="section-title">L·ªãch s·ª≠ ƒë∆°n h√†ng</h3>
                        
                        {% if orders %}
                        <div class="space-y-4">
                            {% for order in orders %}
                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                                <div class="flex items-start justify-between mb-3">
                                    <div>
                                        <p class="font-semibold text-gray-800">ƒê∆°n h√†ng #{{ order.id }}</p>
                                        <p class="text-sm text-gray-500">{{ order.created_at|date:"d/m/Y H:i" }}</p>
                                    </div>
                                    <span class="px-2 py-1 text-xs rounded font-medium
                                        {% if order.status == 'completed' %}bg-green-100 text-green-700
                                        {% elif order.status == 'cancelled' %}bg-red-100 text-red-700
                                        {% elif order.status == 'processing' %}bg-blue-100 text-blue-700
                                        {% elif order.status == 'approved' %}bg-purple-100 text-purple-700
                                        {% else %}bg-yellow-100 text-yellow-700{% endif %}">
                                        {% if order.status == 'pending' %}Ch·ªù duy·ªát
                                        {% elif order.status == 'approved' %}ƒê√£ duy·ªát
                                        {% elif order.status == 'processing' %}Ti·∫øp nh·∫≠n
                                        {% elif order.status == 'completed' %}Th√†nh c√¥ng
                                        {% elif order.status == 'cancelled' %}ƒê√£ h·ªßy{% endif %}
                                    </span>
                                </div>
                                
                                <!-- Order Items -->
                                <div class="border-t border-gray-100 pt-3">
                                    {% for item in order.items.all %}
                                    <div class="flex items-center gap-3 py-2">
                                        <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center">
                                            {% if item.product and item.product.image %}
                                            <img src="{{ item.product.image.url }}" alt="{{ item.product_name }}" class="w-14 h-14 object-contain">
                                            {% else %}
                                            <span class="text-2xl">üì±</span>
                                            {% endif %}
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium text-gray-800">{{ item.product_name }}</p>
                                            <p class="text-sm text-gray-500">
                                                {% if item.storage %}{{ item.storage }}{% endif %}
                                                {% if item.storage and item.color %} - {% endif %}
                                                {% if item.color %}{{ item.color }}{% endif %}
                                                x{{ item.quantity }}
                                            </p>
                                        </div>
                                        <p class="font-medium text-red-500">{{ item.subtotal|floatformat:"0"|intcomma }}ƒë</p>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <!-- Order Total -->
                                <div class="border-t border-gray-100 pt-3 mt-2 flex justify-between items-center">
                                    <div class="text-sm">
                                        <span class="text-gray-500">Thanh to√°n:</span>
                                        <span class="font-medium ml-1
                                            {% if order.payment_method == 'cod' %}text-blue-600{% else %}text-green-600{% endif %}">
                                            {% if order.payment_method == 'cod' %}Thanh to√°n khi nh·∫≠n h√†ng{% else %}Thanh to√°n online{% endif %}
                                        </span>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm text-gray-500">T·ªïng ti·ªÅn:</p>
                                        <p class="text-lg font-bold text-red-500">{{ order.total|floatformat:"0"|intcomma }}ƒë</p>
                                    </div>
                                </div>
                                
                                <!-- Actions -->
                                <div class="mt-3 flex gap-2">
                                    <a href="{% url 'order_detail' order.id %}" 
                                       class="btn-secondary">
                                        Xem chi ti·∫øt
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <p>B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>
                            <a href="/" class="btn-primary mt-4 inline-block">Mua s·∫Øm ngay</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Tab: G√≥p √Ω (Feedback) -->
                <div id="tab-feedback" class="{% if active_tab != 'feedback' %}hidden{% endif %}">
                    <div class="profile-content-card">
                        <h3 class="section-title">G√≥p √Ω c·ªßa b·∫°n</h3>
                        
                        <!-- Feedback Form -->
                        <form method="POST" action="{% url 'feedback_create' %}" class="mb-6">
                            {% csrf_token %}
                            <div class="mb-4">
                                <label class="profile-label">Ti√™u ƒë·ªÅ</label>
                                <input type="text" name="title" 
                                       placeholder="Nh·∫≠p ti√™u ƒë·ªÅ g√≥p √Ω"
                                       class="profile-input" required>
                            </div>
                            <div class="mb-4">
                                <label class="profile-label">N·ªôi dung</label>
                                <textarea name="content" rows="4"
                                          placeholder="Nh·∫≠p n·ªôi dung g√≥p √Ω c·ªßa b·∫°n..."
                                          class="profile-input" required></textarea>
                            </div>
                            <button type="submit" class="btn-primary">
                                G·ª≠i g√≥p √Ω
                            </button>
                        </form>
                        
                        <!-- Feedback List -->
                        {% if feedbacks %}
                        <div class="border-t border-gray-200 pt-6">
                            <h4 class="font-semibold text-gray-700 mb-4">L·ªãch s·ª≠ g√≥p √Ω</h4>
                            <div class="space-y-4">
                                {% for feedback in feedbacks %}
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex items-start justify-between mb-2">
                                        <div>
                                            <p class="font-semibold text-gray-800">{{ feedback.title }}</p>
                                            <p class="text-sm text-gray-500">{{ feedback.created_at|date:"d/m/Y H:i" }}</p>
                                        </div>
                                        {% if feedback.is_responded %}
                                        <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">ƒê√£ ph·∫£n h·ªìi</span>
                                        {% else %}
                                        <span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded">Ch·ªù ph·∫£n h·ªìi</span>
                                        {% endif %}
                                    </div>
                                    <p class="text-gray-600 mb-2">{{ feedback.content }}</p>
                                    
                                    {% if feedback.is_responded %}
                                    <div class="bg-blue-50 rounded-lg p-3 mt-3">
                                        <p class="text-sm font-medium text-blue-800 mb-1">
                                            <i class="fas fa-reply mr-1"></i>Ph·∫£n h·ªìi t·ª´ QHUN22 ({{ feedback.responded_at|date:"d/m/Y H:i" }}):
                                        </p>
                                        <p class="text-sm text-gray-700">{{ feedback.admin_response }}</p>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/profile.js' %}"></script>
{% endblock %}
